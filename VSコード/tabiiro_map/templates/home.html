{% extends "base.html" %}

{% block title %}æ—…è‰²ãƒãƒƒãƒ— - ãƒ›ãƒ¼ãƒ {% endblock %}

{% block main_content %}
    <div class="two-column-layout">
        <div class="map-placeholder">
            <svg id="japan-map" viewbox="0 0 1000 1000" style="width: 100%; height: 100%;">
                <rect x="50" y="50" width="900" height="900" fill="#EFEFEF" stroke="#333" stroke-width="2" />
                
                <path id="pref13" data-name="æ±äº¬éƒ½" fill="#CCCCCC" d="..." style="cursor: pointer;"/>
                <path id="pref27" data-name="å¤§é˜ªåºœ" fill="#CCCCCC" d="..." style="cursor: pointer;"/>
                
                <text id="map-loading-text" x="500" y="400" font-size="30" text-anchor="middle" fill="#666">
                    åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...
                </text>
            </svg>
        </div>

        <div class="right-blocks-container">
            <div class="info-block block-item">
                <a href="#">æƒ…å ±</a>
            </div>
            <div class="search-block block-item">
                <a href="#">æ¤œç´¢</a>
            </div>
            <div class="record-block block-item">
                <a href="#">è¨˜éŒ²</a>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ----------------------------------------------------
            // ğŸ¨ éƒ½é“åºœçœŒã®è‰²ä»˜ã‘ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‚ç…§ï¼‰
            // ----------------------------------------------------
            
            // 1. è‰²ã®å®šç¾©
            const colorMap = {
                'visited': '#007BFF',       // è¨ªå•æ¸ˆã¿ã®è‰²ï¼ˆé’ï¼‰
                'want_to_go': '#FFC107',    // èˆˆå‘³ã‚ã‚Šã®è‰²ï¼ˆé»„è‰²ï¼‰
                'default': '#DDDDDD'        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰²ï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰
            };

            const japanMap = document.getElementById('japan-map');
            const loadingText = document.getElementById('map-loading-text');

            /**
             * 2. APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€åœ°å›³ã«è‰²ã‚’ä»˜ã‘ã‚‹é–¢æ•°
             */
            async function fetchAndRenderMap() {
                if (loadingText) {
                    loadingText.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...";
                }

                try {
                    // ğŸš¨ ã“ã“ã‚’å®Ÿéš›ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¤‰æ›´ã—ã¦ãã ã•ã„ ğŸš¨
                    const apiUrl = '/api/travel-records'; 
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
                    }
                    
                    // JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    // æƒ³å®šã•ã‚Œã‚‹JSONã®å½¢å¼: {"pref13": {"status": "visited", "count": 5}, "pref27": {...}, ...}
                    const travelRecords = await response.json(); 

                    if (loadingText) {
                        loadingText.style.display = 'none'; // ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                    }

                    if (japanMap) {
                        applyColorsToMap(japanMap, travelRecords);
                    }
                    
                } catch (error) {
                    console.error("åœ°å›³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                    if (loadingText) {
                        loadingText.textContent = "ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                    }
                }
            }

            /**
             * 3. å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦åœ°å›³ã«è‰²ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
             */
            function applyColorsToMap(mapElement, records) {
                const prefectures = mapElement.querySelectorAll('path[id^="pref"]');

                prefectures.forEach(pref => {
                    const prefId = pref.id;
                    const record = records[prefId];
                    const prefName = pref.dataset.name || prefId; 

                    let color = colorMap.default;
                    let recordStatus = 'æœªç™»éŒ²';

                    if (record) {
                        color = colorMap[record.status] || colorMap.default;
                        recordStatus = record.status;
                    }

                    // è‰²ã®é©ç”¨ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                    pref.setAttribute('fill', color);
                    setupEventListeners(pref, prefName, record, color);
                });
            }

            /**
             * 4. éƒ½é“åºœçœŒã”ã¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹é–¢æ•°
             */
            function setupEventListeners(prefElement, prefName, record, originalColor) {
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                prefElement.addEventListener('click', function() {
                    alert(`${prefName}ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã—ãŸï¼\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${record ? record.status : 'æœªç™»éŒ²'}\nè¨˜éŒ²æ•°: ${record ? record.count : 0}`);
                    // è©³ç´°ãƒšãƒ¼ã‚¸ã¸ã®é·ç§»å‡¦ç†ãªã©
                });

                // ãƒ›ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
                prefElement.addEventListener('mouseover', function() {
                    this.setAttribute('fill', '#6C757D'); // ãƒ›ãƒãƒ¼ã§ã‚°ãƒ¬ãƒ¼ã«ä¸€æ™‚å¤‰æ›´
                });

                prefElement.addEventListener('mouseout', function() {
                    this.setAttribute('fill', originalColor); // å…ƒã®è‰²ã«æˆ»ã™
                });
            }

            // 5. åœ°å›³ã®æç”»å‡¦ç†ã‚’é–‹å§‹
            fetchAndRenderMap();
        });
    </script>
{% endblock %}