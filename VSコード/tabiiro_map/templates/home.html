{% extends "base.html" %}

{% block title %}æ—…è‰²ãƒãƒƒãƒ— - ãƒ›ãƒ¼ãƒ {% endblock %}

{% block main_content %}
    <div class="two-column-layout">
        <!-- å·¦å´ã®å¤§ããªã‚¨ãƒªã‚¢: Japan Map ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="map-placeholder">
            <div id="japan-map-container">
                <!-- 
                    âš ï¸ æ³¨æ„: 
                    ã“ã‚Œã¯Japan Mapã®å‹•ä½œç¢ºèªç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªSVGãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã§ã™ã€‚
                    å…¨ã¦ã®éƒ½é“åºœçœŒã®å¢ƒç•Œç·šã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€å®Ÿéš›ã®æ—¥æœ¬ã®GeoJSON/SVGãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                -->
                <svg id="japan-map" viewbox="0 0 1000 1000">
                    <rect x="0" y="0" width="1000" height="1000" fill="#F0F0F0" stroke="#333" stroke-width="5" />
                    <text x="500" y="50" font-size="30" text-anchor="middle" fill="#666">
                        æ—¥æœ¬åœ°å›³ (å‹•ä½œç¢ºèªç”¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼)
                    </text>
                    
                    <!-- å‹•ä½œç¢ºèªç”¨ã®éƒ½é“åºœçœŒãƒ‘ã‚¹ (app.pyã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œ) -->
                    <!-- åŒ—æµ·é“: pref01 -->
                    <path id="pref01" data-name="åŒ—æµ·é“" fill="#CCCCCC" d="M 200 100 L 400 100 L 400 200 L 200 200 Z" style="cursor: pointer; stroke: #FFF; stroke-width: 2;"/>
                    <text x="300" y="150" font-size="15" text-anchor="middle">åŒ—æµ·é“</text>
                    
                    <!-- æ±äº¬éƒ½: pref13 -->
                    <path id="pref13" data-name="æ±äº¬éƒ½" fill="#CCCCCC" d="M 650 350 L 700 350 L 700 400 L 650 400 Z" style="cursor: pointer; stroke: #FFF; stroke-width: 2;"/>
                    <text x="675" y="375" font-size="15" text-anchor="middle">æ±äº¬</text>

                    <!-- é™å²¡çœŒ: pref22 -->
                    <path id="pref22" data-name="é™å²¡çœŒ" fill="#CCCCCC" d="M 600 400 L 650 400 L 650 450 L 600 450 Z" style="cursor: pointer; stroke: #FFF; stroke-width: 2;"/>
                    <text x="625" y="425" font-size="15" text-anchor="middle">é™å²¡</text>

                    <!-- å¤§é˜ªåºœ: pref27 -->
                    <path id="pref27" data-name="å¤§é˜ªåºœ" fill="#CCCCCC" d="M 500 500 L 550 500 L 550 550 L 500 550 Z" style="cursor: pointer; stroke: #FFF; stroke-width: 2;"/>
                    <text x="525" y="525" font-size="15" text-anchor="middle">å¤§é˜ª</text>
                    
                    <!-- ç¦å²¡çœŒ: pref40 -->
                    <path id="pref40" data-name="ç¦å²¡çœŒ" fill="#CCCCCC" d="M 300 700 L 400 700 L 400 800 L 300 800 Z" style="cursor: pointer; stroke: #FFF; stroke-width: 2;"/>
                    <text x="350" y="750" font-size="15" text-anchor="middle">ç¦å²¡</text>
                </svg>
            </div>
        </div>

        <!-- å³å´ã®ç¸¦ã«ä¸¦ã‚“ã 3ã¤ã®ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚³ãƒ³ãƒ†ãƒŠ (å¤‰æ›´ãªã—) -->
        <div class="right-blocks-container">
            <div class="info-block block-item">
                <a href="#">æƒ…å ±</a>
            </div>
            <div class="search-block block-item">
                <a href="#">æ¤œç´¢</a>
            </div>
            <div class="record-block block-item">
                <a href="#">è¨˜éŒ²</a>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Japan Map ã®ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Japan Map ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœ¬ä½“ -->
    <script src="https://unpkg.com/japan-map/dist/jquery.japan-map.min.js"></script>

    <script>
        $(document).ready(function() {
            // ----------------------------------------------------
            // ğŸ¨ Japan Map ã«ã‚ˆã‚‹è‰²ä»˜ã‘ãƒ­ã‚¸ãƒƒã‚¯
            // ----------------------------------------------------
            
            const colorMap = {
                'visited': '#007BFF',       // è¨ªå•æ¸ˆã¿ã®è‰² (é’)
                'want_to_go': '#FFC107',    // èˆˆå‘³ã‚ã‚Šã®è‰² (é»„)
                'default': '#DDDDDD'        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰² (ã‚°ãƒ¬ãƒ¼)
            };

            const $mapContainer = $('#japan-map-container');
            
            async function fetchAndRenderMap() {
                try {
                    const apiUrl = '{{ url_for("travel_records_api") }}';
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
                    }
                    
                    const travelRecords = await response.json(); 

                    const areasData = {};
                    for (let i = 1; i <= 47; i++) {
                        // 1ã‹ã‚‰47ã¾ã§ã®IDæ–‡å­—åˆ— ('pref01', 'pref02', ...) ã‚’ç”Ÿæˆ
                        const prefId = 'pref' + String(i).padStart(2, '0');
                        const record = travelRecords[prefId];

                        let color = colorMap.default;
                        if (record) {
                            color = colorMap[record.status] || colorMap.default;
                        }
                        
                        // Japan Map ã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹ç¯‰
                        areasData[i] = {
                            name: $('#' + prefId).attr('data-name') || "æœªç™»éŒ²ã‚¨ãƒªã‚¢",
                            color: color,
                            hoverColor: '#6C757D', 
                            record: record || { status: 'æœªç™»éŒ²', count: 0 }
                        };
                    }
                    
                    // 5. Japan Map ã®åˆæœŸåŒ–ã¨æç”»
                    $mapContainer.japanMap({
                        areas: areasData, // ä½œæˆã—ãŸã‚¨ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
                        selection: "all",
                        drawsBox: true, 
                        width: "100%",
                        onSelect: function(data){
                            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                            const selectedPrefId = data.area.attr('id');
                            const prefIndex = parseInt(selectedPrefId.replace('pref', ''));
                            
                            // é¸æŠã•ã‚ŒãŸã‚¨ãƒªã‚¢ã®ãƒ‡ãƒ¼ã‚¿ãŒ areasData ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                            if (areasData[prefIndex]) {
                                const recordData = areasData[prefIndex].record;
                                alert(`${areasData[prefIndex].name}ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã—ãŸï¼\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${recordData.status}\nè¨˜éŒ²æ•°: ${recordData.count}`);
                            } else {
                                alert("ã‚¨ãƒªã‚¢æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error("åœ°å›³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºãªã©
                }
            }

            // åœ°å›³ã®æç”»å‡¦ç†ã‚’é–‹å§‹
            fetchAndRenderMap();
        });
    </script>
{% endblock %}